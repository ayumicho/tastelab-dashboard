{% extends "base.html" %}
{% block title %} Experiments {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/experiments.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="header">
        <div>
            <h1 class="header-title"> Experiments</h1>
            <p class="header-subtitle">Browse and analyze historical sensory testing experiments</p>
        </div>
        <button class="btn btn-one" onclick="location.href='/experiments/add-experiment'">Add Experiment</button>
    </div>

    <!-- Tab links -->
    <div class="tabs-container">
        <div class="tabs-nav">
            <button class="tab-button active" onclick="openTab(event, 'recent')">Recent</button>
            <button class="tab-button" onclick="openTab(event, 'completed')">All Experiments</button>
            <button class="tab-button" onclick="openTab(event, 'archived')">Archived</button>
        </div>

        <!-- Recent Experiments Tab -->
        <div id="recent" class="tab-content active">
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle filter-select" type="button" id="categoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <span id="selectedCategory">All Categories</span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="categoryDropdown">
                    <li><a class="dropdown-item active" href="#" data-category="">All Categories</a></li>
                    {% for tag in tags %}
                    <li><a class="dropdown-item" href="#" data-category="{{ tag }}">{{ tag }}</a></li>
                    {% endfor %}
                </ul>
            </div>

            {% if recent_experiments %}
                <div class="experiments-grid">
                {% for experiment in recent_experiments %}
                    <div class="experiment-card" data-tags="{{ experiment.tags if experiment.tags else '' }}">
                        <div class="experiment-header">
                            <div>
                                <h3 class="experiment-title">{{ experiment.title }}</h3>
                                <div class="experiment-date">{{ experiment.date.strftime('%B %d, %Y') if experiment.date else 'N/A' }}</div>
                            </div>
                        </div>
                        <p class="experiment-description">
                            {{ experiment.description }}
                        </p>
                        <div class="tags-section">
                            {% if experiment.tags %}
                            <div class="tags-list">
                                {% for tag in experiment.tags.split(',') %}
                                <span class="tag">{{ tag.strip() }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="experiment-stats">
                            <div class="stat">
                                <div class="stat-value">{{ experiment.participant_count }}</div>
                                <div class="stat-label">Participants</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">{{ experiment.avg_score }}</div>
                                <div class="stat-label">Avg Score</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">{{ experiment.format_duration() }}</div>
                                <div class="stat-label">Duration</div>
                            </div>
                        </div>
                        <div class="experiment-actions">
                            <a href="{{ url_for('views.view_experiment', experiment_id=experiment.id) }}" class="btn btn-primary">
                            View Results
                            </a>
                        </div>
                    </div>    
                {% endfor %}    
                </div>
            {% else %}
                <div class="empty-state">
                    <h3>No completed experiments yet</h3>
                    <p>Completed experiments will appear here</p>
                </div>
            {% endif %}
        </div>

        <!-- All Experiments Tab -->
        <div id="completed" class="tab-content">
            <select class="filter-select">
                <option>All Time Periods</option>
                <option>Last 3 Months</option>
                <option>Last 6 Months</option>
                <option>Last Year</option>
            </select>

            {% if all_experiments %}
                <div class="experiments-grid">
                {% for experiment in all_experiments %}    
                    <div class="experiment-card">
                        <div class="status-badge status-completed">All</div>
                        <div class="experiment-header">
                            <div>
                                <h3 class="experiment-title">{{ experiment.title }}</h3>
                                <div class="experiment-date">{{ experiment.date }}</div>
                            </div>
                        </div>
                        <p class="experiment-description">
                            {{ experiment.description }}
                        </p>
                        <div class="experiment-tags">
                            <span class="tag">{{ experiment.tags }}</span>
                        </div>
                        <div class="experiment-stats">
                            <div class="stat">
                                <div class="stat-value">{{ experiment.participant_count }}</div>
                                <div class="stat-label">Participants</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">{{ experiment.avg_score }}</div>
                                <div class="stat-label">Avg Score</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">{{ experiment.format_duration() }}</div>
                                <div class="stat-label">Duration</div>
                            </div>
                        </div>
                        <div class="experiment-actions">
                            <button href="{{ url_for('views.view_experiment', experiment_id=experiment.id) }}"  class="btn btn-primary">Full Report</button>
                        </div>
                    </div>
                {% endfor %}    
                </div>
            {% else %}
                <div class="empty-state">
                    <h3>No completed experiments yet</h3>
                    <p>Completed experiments will appear here</p>
                </div>
            {% endif %}
        </div>

        <!-- Archived Experiments Tab -->
        <div id="archived" class="tab-content">
            {% if archived_experiments %}
                <div class="experiments-grid">
                {% for experiment in archived_experiments %}    
                    <div class="experiment-card">
                        <div class="status-badge status-archived">{{ experiment.status }}</div>
                        <div class="experiment-header">
                            <div>
                                <h3 class="experiment-title">{{ experiment.title }}</h3>
                                <div class="experiment-date">{{ experiment.date }}</div>
                            </div>
                        </div>
                        <p class="experiment-description">
                            {{ experiment.description }}
                        </p>
                        <div class="experiment-tags">
                            <span class="tag">{{ experiment.tags }}</span>
                        </div>
                        <div class="experiment-stats">
                            <div class="stat">
                                <div class="stat-value">{{ experiment.participant_count }}</div>
                                <div class="stat-label">Participants</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">{{ experiment.avg_score }}</div>
                                <div class="stat-label">Avg Score</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">{{ experiment.format_duration() }}</div>
                                <div class="stat-label">Duration</div>
                            </div>
                        </div>
                        <div class="experiment-actions">
                            <button class="btn btn-primary">View Archive</button>
                        </div>
                    </div>
                {% endfor %}        
                </div>
            {% else %}
                <div class="empty-state">
                    <h3>No archived experiments yet</h3>
                    <p>Archived experiments will appear here</p>
                </div>
            {% endif %}                    
        </div>    
    </div>
</div>

<script>
    function openTab(event, tabName) {
        console.log('Tab clicked:', tabName);
        
        //Hide all tab content
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content=> {
            content.classList.remove('active');   
        });

        //Remove active class from all buttons
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
            button.classList.remove('active');
        });

        //show the selected tab
        document.getElementById(tabName).classList.add('active');
        console.log('Active tab now:', document.getElementById(tabName));

        // Add active class
        event.currentTarget.classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', function() {
        const dropdownItems = document.querySelectorAll('.dropdown-item');
        const selectedCategory = document.getElementById('selectedCategory');
        
        dropdownItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all items
                dropdownItems.forEach(i => i.classList.remove('active'));
                
                // Add active class to clicked item
                this.classList.add('active');
                
                // Update button text
                selectedCategory.textContent = this.textContent;
                
                // Get selected category
                const category = this.getAttribute('data-category');
                
                // Filter experiments
                filterExperiments(category);
            });
        });
    });

    function filterExperiments(category) {
        // Get all experiment cards in the ACTIVE tab only
        const activeTab = document.querySelector('.tab-content.active');
        const experimentCards = activeTab.querySelectorAll('.experiment-card');
        
        experimentCards.forEach(card => {
            if (category === '') {
                // Show all if "All Categories" selected
                card.style.display = '';
            } else {
                // Check if card has the selected tag
                const cardTags = card.getAttribute('data-tags');
                if (cardTags && cardTags.toLowerCase().includes(category.toLowerCase())) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            }
        });
    }
</script>

{% endblock %}
