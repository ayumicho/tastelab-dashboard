{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

{% endblock %}

{% block content %}

<div class="container-fluid py-4">
    <!-- Enhanced Dashboard Header -->
    <div class="dashboard-header-section">
        <div class="header-content-wrapper">
            <div class="welcome-section">
                <h1 class="dashboard-title">Welcome back, {{ user.first_name }}!</h1>
                <p class="dashboard-subtitle">Here's what's happening with your sensory experiments today</p>
            </div>
        </div>
    </div>

    <!-- Insight Cards Row -->
    <div class="insight-cards-grid">
        <div class="insight-card purple">
            <div class="insight-icon">
                <i class="fas fa-flask"></i>
            </div>
            <div class="insight-content">
                <div class="insight-label">Total Experiments</div>
                <div class="insight-value">{{ stats.total_experiments }}</div>
                <div class="insight-change">
                    <i class="fas fa-chart-line"></i>
                    All recorded experiments
                </div>
            </div>
        </div>
        
        <div class="insight-card green">
            <div class="insight-icon">
                <i class="fas fa-brain"></i>
            </div>
            <div class="insight-content">
                <div class="insight-label">With Analysis</div>
                <div class="insight-value">{{ stats.experiments_with_analysis }}</div>
                <div class="insight-change">
                    <i class="fas fa-check-circle"></i>
                    Emotion analyses complete
                </div>
            </div>
        </div>
        
        <div class="insight-card blue">
            <div class="insight-icon">
                <i class="fas fa-list-ol"></i>
            </div>
            <div class="insight-content">
                <div class="insight-label">Total Segments</div>
                <div class="insight-value">{{ stats.total_segments or 0 }}</div>
                <div class="insight-change">
                    <i class="fas fa-database"></i>
                    Analyzed data segments
                </div>
            </div>
        </div>
        
        <div class="insight-card orange">
            <div class="insight-icon">
                <i class="fas fa-check-double"></i>
            </div>
            <div class="insight-content">
                <div class="insight-label">Completed</div>
                <div class="insight-value">{{ stats.completed_experiments }}</div>
                <div class="insight-change">
                    <i class="fas fa-flag-checkered"></i>
                    Finished experiments
                </div>
            </div>
        </div>
    </div>

    <!-- Experiment Selector Card -->
    <div class="selector-card">
        <div class="selector-header">
            <div class="selector-title-section">
                <i class="fas fa-filter"></i>
                <h3>Select Experiment to View</h3>
            </div>
            <div class="selector-actions">
                <button class="btn-icon" id="compareBtn" title="Compare Experiments">
                    <i class="fas fa-balance-scale"></i>
                </button>
                <button class="btn-icon" id="exportBtn" title="Export Data">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
        <div class="selector-content">
            <select class="experiment-select-modern" id="experimentSelect">
                {% if experiments %}
                    {% for exp in experiments %}
                        <option value="{{ exp.id }}" {% if selected_experiment and selected_experiment.id == exp.id %}selected{% endif %}>
                            {{ exp.title }} ({{ exp.date.strftime('%b %d, %Y') }})
                            {% if exp.analysis %} âœ“ Analyzed{% endif %}
                        </option>
                    {% endfor %}
                {% else %}
                    <option value="">No experiments available</option>
                {% endif %}
            </select>
        </div>
    </div>

    {% if selected_experiment %}
    <!-- Selected Experiment Overview -->
    <div class="experiment-overview-card">
        <div class="overview-header">
            <div class="overview-title-section">
                <h2 class="overview-title">{{ selected_experiment.title }}</h2>
                {% if analysis %}
                    <span class="analysis-status-badge complete">
                        <i class="fas fa-check-circle"></i>
                        Analysis Complete
                    </span>
                {% else %}
                    <span class="analysis-status-badge pending">
                        <i class="fas fa-clock"></i>
                        No Analysis
                    </span>
                {% endif %}
            </div>
            {% if selected_experiment.description %}
            <p class="overview-description">{{ selected_experiment.description }}</p>
            {% endif %}
        </div>

        <!-- Experiment Metadata Grid -->
        <div class="metadata-grid">
            <div class="metadata-card">
                <div class="metadata-icon participants">
                    <i class="fas fa-users"></i>
                </div>
                <div class="metadata-content">
                    <div class="metadata-value">{{ selected_experiment.participant_count or 0 }}</div>
                    <div class="metadata-label">Participants</div>
                </div>
            </div>
            
            <div class="metadata-card">
                <div class="metadata-icon calendar">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="metadata-content">
                    <div class="metadata-value">{{ selected_experiment.date.strftime('%d') }}</div>
                    <div class="metadata-label">{{ selected_experiment.date.strftime('%B %Y') }}</div>
                </div>
            </div>
            
            <div class="metadata-card">
                <div class="metadata-icon clock">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="metadata-content">
                    <div class="metadata-value">{{ selected_experiment.format_duration() }}</div>
                    <div class="metadata-label">Duration</div>
                </div>
            </div>
            
            <div class="metadata-card">
                <div class="metadata-icon status">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="metadata-content">
                    <div class="metadata-value">{{ selected_experiment.status }}</div>
                    <div class="metadata-label">Status</div>
                </div>
            </div>
        </div>

        {% if selected_experiment.tags %}
        <div class="tags-display">
            <div class="tags-label">
                <i class="fas fa-tags"></i>
                <span>Tags:</span>
            </div>
            <div class="tags-list-display">
                {% for tag in selected_experiment.tags.split(',') %}
                    <span class="tag-item">{{ tag.strip() }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Emotion Analysis Section -->
    {% if analysis %}
    <div class="analysis-results-card">
        <div class="analysis-header">
            <div class="analysis-title-section">
                <i class="fas fa-brain"></i>
                <h2>Emotion Analysis Results</h2>
            </div>
            <a href="{{ url_for('views.transcription', id=selected_experiment.id) }}" class="btn-view-full">
                View Full Analysis
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>

        <!-- Analysis Metrics -->
        <div class="analysis-metrics-grid">
            <div class="analysis-metric primary">
                <div class="metric-icon">
                    <i class="fas fa-smile"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Dominant Emotion</div>
                    <div class="metric-value">{{ analysis.dominant_emotion|title }}</div>
                </div>
            </div>
            
            <div class="analysis-metric">
                <div class="metric-icon">
                    <i class="fas fa-list"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Total Segments</div>
                    <div class="metric-value">{{ analysis.total_segments or 0 }}</div>
                </div>
            </div>
            
            <div class="analysis-metric">
                <div class="metric-icon">
                    <i class="fas fa-font"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Words Analyzed</div>
                    <div class="metric-value">{{ analysis.word_count or 0 }}</div>
                </div>
            </div>
            
            <div class="analysis-metric">
                <div class="metric-icon">
                    <i class="fas fa-book-reader"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Reading Time</div>
                    <div class="metric-value">{{ "%.1f"|format(analysis.reading_time_minutes or 0) }}m</div>
                </div>
            </div>
        </div>

        <!-- Emotion Distribution -->
        {% if analysis.emotion_summary and analysis.emotion_summary.emotion_percentages %}
        <div class="emotion-distribution-section">
            <h3 class="section-title">
                <i class="fas fa-chart-pie"></i>
                Emotion Distribution
            </h3>
            <div class="distribution-grid">
                <div class="distribution-bars-section">
                    {% for emotion, percentage in analysis.emotion_summary.emotion_percentages.items() %}
                    <div class="emotion-bar-item">
                        <div class="emotion-bar-header">
                            <span class="emotion-name">{{ emotion|title }}</span>
                            <span class="emotion-percent">{{ "%.1f"|format(percentage) }}%</span>
                        </div>
                        <div class="emotion-progress-track">
                            <div class="emotion-progress-bar" style="width: {{ percentage }}%;" data-emotion="{{ emotion|lower }}"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="distribution-chart-section">
                    <canvas id="emotionPieChart"></canvas>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Additional Analysis Metrics -->
        <div class="additional-metrics-grid">
            <div class="additional-metric purple">
                <div class="additional-metric-icon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <div class="additional-metric-content">
                    <div class="additional-metric-value">{{ analysis.questions.count() }}</div>
                    <div class="additional-metric-label">Questions Detected</div>
                </div>
            </div>
            
            <div class="additional-metric pink">
                <div class="additional-metric-icon">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="additional-metric-content">
                    <div class="additional-metric-value">{{ analysis.actions.count() }}</div>
                    <div class="additional-metric-label">Action Items</div>
                </div>
            </div>
            
            <div class="additional-metric blue">
                <div class="additional-metric-icon">
                    <i class="fas fa-key"></i>
                </div>
                <div class="additional-metric-content">
                    <div class="additional-metric-value">{{ analysis.keywords.count() }}</div>
                    <div class="additional-metric-label">Keywords</div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- No Analysis Available -->
    <div class="no-analysis-card">
        <div class="no-analysis-content">
            <div class="no-analysis-icon">
                <i class="fas fa-database"></i>
            </div>
            <h3>No Emotion Analysis Data</h3>
            <p>Import emotion analysis data from MinIO to see detailed insights for this experiment.</p>
            <form method="POST" action="{{ url_for('views.manual_sync') }}" style="display: inline;">
                <button class="code-snippet">
                    <i class="fas fa-terminal"></i>
                    <code>Sync MinIO Data</code>
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Charts Row -->
    <div class="charts-row">
        <div class="chart-card">
            <div class="chart-header">
                <i class="fas fa-chart-line"></i>
                <h3>Participant Trends</h3>
            </div>
            <div class="chart-container-wrapper">
                <canvas id="participantChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <i class="fas fa-chart-pie"></i>
                <h3>Experiment Categories</h3>
            </div>
            <div class="chart-container-wrapper">
                <canvas id="tagChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Quick Actions Panel -->
    <div class="quick-actions-card">
        <div class="quick-actions-header">
            <i class="fas fa-bolt"></i>
            <h2>Quick Actions</h2>
        </div>
        <div class="quick-actions-grid">
            <a href="{{ url_for('views.transcription') }}" class="action-button">
                <div class="action-icon purple">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="action-content">
                    <div class="action-title">Emotion Analysis</div>
                    <div class="action-description">View detailed analyses</div>
                </div>
                <i class="fas fa-arrow-right action-arrow"></i>
            </a>
            
            <a href="{{ url_for('views.experiments') }}" class="action-button">
                <div class="action-icon green">
                    <i class="fas fa-flask"></i>
                </div>
                <div class="action-content">
                    <div class="action-title">All Experiments</div>
                    <div class="action-description">Browse experiments</div>
                </div>
                <i class="fas fa-arrow-right action-arrow"></i>
            </a>
            
            <a href="{{ url_for('views.analytics') }}" class="action-button">
                <div class="action-icon blue">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="action-content">
                    <div class="action-title">Analytics</div>
                    <div class="action-description">View insights</div>
                </div>
                <i class="fas fa-arrow-right action-arrow"></i>
            </a>
            
            <a href="{{ url_for('views.add_experiment') }}" class="action-button">
                <div class="action-icon orange">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <div class="action-content">
                    <div class="action-title">New Experiment</div>
                    <div class="action-description">Add new data</div>
                </div>
                <i class="fas fa-arrow-right action-arrow"></i>
            </a>
        </div>
    </div>

    <!-- Recent Activity & Top Experiments -->
    <div class="activity-section-grid">
        <div class="activity-card">
            <div class="activity-header">
                <i class="fas fa-history"></i>
                <h3>Recent Activity</h3>
            </div>
            <div class="activity-list">
                {% for exp in recent_activity %}
                <div class="activity-list-item">
                    <div class="activity-item-icon {% if exp.analysis %}analyzed{% endif %}">
                        <i class="fas {% if exp.analysis %}fa-check-circle{% else %}fa-flask{% endif %}"></i>
                    </div>
                    <div class="activity-item-content">
                        <div class="activity-item-title">{{ exp.title }}</div>
                        <div class="activity-item-meta">
                            <span><i class="fas fa-users"></i> {{ exp.participant_count or 0 }}</span>
                            <span><i class="fas fa-clock"></i> {{ exp.format_duration() }}</span>
                            {% if exp.analysis %}<span class="analyzed-badge"><i class="fas fa-brain"></i> Analyzed</span>{% endif %}
                        </div>
                        <div class="activity-item-date">{{ exp.date.strftime('%B %d, %Y') }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="top-experiments-card">
            <div class="top-experiments-header">
                <i class="fas fa-trophy"></i>
                <h3>Top Experiments</h3>
            </div>
            <div class="top-experiments-list-modern">
                {% for exp in top_experiments %}
                <div class="top-experiment-modern">
                    <div class="top-rank">{{ loop.index }}</div>
                    <div class="top-content">
                        <div class="top-title">{{ exp.title }}</div>
                        <div class="top-date">{{ exp.date.strftime('%b %d, %Y') }}</div>
                    </div>
                    <div class="top-score">
                        <div class="top-value">{{ exp.participant_count or 0 }}</div>
                        <div class="top-label">participants</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {% else %}
    <!-- No Experiments Message -->
    <div class="empty-experiments-card">
        <div class="empty-content">
            <div class="empty-icon">
                <i class="fas fa-flask"></i>
            </div>
            <h3>No Experiments Available</h3>
            <p>Create your first experiment to get started with sensory analysis</p>
            <a href="{{ url_for('views.add_experiment') }}" class="btn-create-first">
                <i class="fas fa-plus"></i>
                Create First Experiment
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Experiment selector
    const experimentSelect = document.getElementById('experimentSelect');
    if (experimentSelect) {
        experimentSelect.addEventListener('change', function() {
            const expId = this.value;
            if (expId) {
                window.location.href = `/?exp_id=${expId}`;
            }
        });
    }

    // Export and Compare buttons
    document.getElementById('exportBtn')?.addEventListener('click', () => alert('Export functionality coming soon!'));
    document.getElementById('compareBtn')?.addEventListener('click', () => alert('Compare functionality coming soon!'));

    // Template data
    const templateData = {
        participantTrend: {
            labels: {{ participant_trend.labels | tojson if participant_trend and participant_trend.labels else '[]' | safe }},
            data: {{ participant_trend.data | tojson if participant_trend and participant_trend.data else '[]' | safe }}
        },
        tagCounts: {{ tag_counts | tojson if tag_counts else '{}' | safe }},
        {% if analysis and analysis.emotion_summary and analysis.emotion_summary.emotion_percentages %}
        emotionData: {{ analysis.emotion_summary.emotion_percentages | tojson | safe }}
        {% else %}
        emotionData: null
        {% endif %}
    };

    // Participant Chart
    const participantCtx = document.getElementById('participantChart');
    if (participantCtx && templateData.participantTrend.labels.length > 0) {
        new Chart(participantCtx, {
            type: 'line',
            data: {
                labels: templateData.participantTrend.labels,
                datasets: [{
                    label: 'Participants',
                    data: templateData.participantTrend.data,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        ticks: { precision: 0 },
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // Tag Chart
    const tagCtx = document.getElementById('tagChart');
    if (tagCtx && Object.keys(templateData.tagCounts).length > 0) {
        new Chart(tagCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(templateData.tagCounts),
                datasets: [{
                    data: Object.values(templateData.tagCounts),
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', 
                        '#4facfe', '#43e97b', '#fa709a',
                        '#ed8936', '#48bb78'
                    ],
                    borderWidth: 3,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 13, weight: '600' },
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8
                    }
                }
            }
        });
    }

    // Emotion Pie Chart
    const emotionCtx = document.getElementById('emotionPieChart');
    if (emotionCtx && templateData.emotionData) {
        const emotionColors = {
            'happy': '#48bb78', 'sad': '#4299e1', 'angry': '#f56565',
            'neutral': '#a0aec0', 'fear': '#ed8936', 'surprise': '#f6e05e', 'disgust': '#9f7aea'
        };
        
        const labels = Object.keys(templateData.emotionData);
        const values = Object.values(templateData.emotionData);
        const colors = labels.map(l => emotionColors[l.toLowerCase()] || '#a0aec0');
        
        new Chart(emotionCtx, {
            type: 'doughnut',
            data: {
                labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 3,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: { size: 13, weight: '600' },
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed.toFixed(1) + '%';
                            }
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}