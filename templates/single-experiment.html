{% extends "base.html" %}

{% block title %}{{ experiment.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/single-experiment.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/experiments.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Enhanced Header with Back Button -->
    <div class="page-navigation">
        <a href="{{ url_for('views.experiments') }}" class="btn-back">
            <i class="fas fa-arrow-left"></i>
            <span>Back to Experiments</span>
        </a>
    </div>
    
    <!-- Experiment Header Section -->
    <div class="experiment-header-section">
        <div class="header-content-wrapper">
            <div class="header-main">
                <h1 class="experiment-main-title">{{ experiment.title }}</h1>
                {% if analysis %}
                    <span class="status-badge badge-analysis">
                        <i class="fas fa-check-circle"></i>
                        Analysis Complete
                    </span>
                {% else %}
                    <span class="status-badge badge-pending">
                        <i class="fas fa-clock"></i>
                        Pending Analysis
                    </span>
                {% endif %}
            </div>
            <p class="experiment-subtitle">Comprehensive experiment results and emotion analysis</p>
        </div>
    </div>

    <!-- Quick Stats Overview -->
    <div class="quick-stats-grid">
        <div class="quick-stat-card">
            <div class="stat-icon-wrapper icon-calendar">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stat-content-wrapper">
                <div class="stat-label">Date</div>
                <div class="stat-value-text">{{ experiment.date.strftime('%B %d, %Y') if experiment.date else 'N/A' }}</div>
            </div>
        </div>
        
        <div class="quick-stat-card">
            <div class="stat-icon-wrapper icon-users">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content-wrapper">
                <div class="stat-label">Participants</div>
                <div class="stat-value-text">{{ experiment.participant_count }}</div>
            </div>
        </div>
        
        <div class="quick-stat-card">
            <div class="stat-icon-wrapper icon-clock">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content-wrapper">
                <div class="stat-label">Duration</div>
                <div class="stat-value-text">{{ experiment.format_duration() }}</div>
            </div>
        </div>
        
        <div class="quick-stat-card">
            <div class="stat-icon-wrapper icon-status">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="stat-content-wrapper">
                <div class="stat-label">Status</div>
                <div class="stat-value-text">{{ experiment.status }}</div>
            </div>
        </div>
    </div>

    <!-- Experiment Details Card -->
    <div class="content-card">
        <div class="card-header-section">
            <h2 class="card-title">
                <i class="fas fa-file-alt"></i>
                Experiment Details
            </h2>
        </div>
        
        {% if experiment.description %}
        <div class="detail-section">
            <h3 class="section-subtitle">Description</h3>
            <p class="description-text">{{ experiment.description }}</p>
        </div>
        {% endif %}
        
        {% if experiment.tags %}
        <div class="detail-section">
            <h3 class="section-subtitle">Tags</h3>
            <div class="tags-container">
                {% for tag in experiment.tags.split(',') %}
                <span class="experiment-tag">
                    <i class="fas fa-tag"></i>
                    {{ tag.strip() }}
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    {% if analysis %}
    <!-- Emotion Analysis Overview -->
    <div class="content-card highlight-card">
        <div class="card-header-section">
            <h2 class="card-title">
                <i class="fas fa-brain"></i>
                Emotion Analysis Overview
            </h2>
        </div>
        
        <div class="metrics-grid">
            <div class="metric-box primary-metric">
                <div class="metric-icon">
                    <i class="fas fa-smile"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Dominant Emotion</div>
                    <div class="metric-value">{{ analysis.dominant_emotion|title }}</div>
                </div>
            </div>
            
            <div class="metric-box">
                <div class="metric-icon">
                    <i class="fas fa-list-ol"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Total Segments</div>
                    <div class="metric-value">{{ analysis.total_segments or 0 }}</div>
                </div>
            </div>
            
            <div class="metric-box">
                <div class="metric-icon">
                    <i class="fas fa-font"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Words Analyzed</div>
                    <div class="metric-value">{{ analysis.word_count or 0 }}</div>
                </div>
            </div>
            
            <div class="metric-box">
                <div class="metric-icon">
                    <i class="fas fa-book-reader"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Reading Time</div>
                    <div class="metric-value">{{ "%.1f"|format(analysis.reading_time_minutes or 0) }}m</div>
                </div>
            </div>
        </div>

        {% if summary and summary.emotion_percentages %}
        <div class="emotion-distribution-section">
            <h3 class="section-subtitle">Emotion Distribution</h3>
            <div class="distribution-layout">
                <div class="distribution-bars">
                    {% for emotion, percentage in summary.emotion_percentages.items() %}
                    <div class="emotion-bar-wrapper">
                        <div class="emotion-bar-header">
                            <span class="emotion-name">
                                <i class="fas fa-circle emotion-indicator"></i>
                                {{ emotion|title }}
                            </span>
                            <span class="emotion-percentage">{{ "%.1f"|format(percentage) }}%</span>
                        </div>
                        <div class="emotion-progress-bar">
                            <div class="emotion-progress-fill" style="width: {{ percentage }}%;" data-emotion="{{ emotion|lower }}"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="distribution-chart">
                    <canvas id="emotionPieChart"></canvas>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="action-button-section">
            <a href="{{ url_for('views.transcription', id=experiment.id) }}" class="btn-action primary">
                <i class="fas fa-chart-line"></i>
                View Full Emotion Analysis
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </div>

    <!-- Keywords Section -->
    {% if keywords_preview %}
    <div class="content-card">
        <div class="card-header-section">
            <h2 class="card-title">
                <i class="fas fa-key"></i>
                Top Keywords
            </h2>
        </div>
        <div class="keyword-cloud-container">
            {% for keyword in keywords_preview %}
                <span class="keyword-bubble">{{ keyword.text }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Timeline Preview -->
    {% if timeline_preview %}
    <div class="content-card">
        <div class="card-header-section">
            <h2 class="card-title">
                <i class="fas fa-stream"></i>
                Emotion Timeline Preview
            </h2>
        </div>
        <div class="timeline-container">
            {% for segment in timeline_preview %}
            <div class="timeline-segment">
                <div class="timeline-timestamp">
                    <i class="fas fa-clock"></i>
                    {{ "%.1f"|format(segment.start_time) }}s
                </div>
                <div class="timeline-content">
                    <span class="timeline-emotion-badge" data-emotion="{{ segment.primary_emotion|lower }}">
                        {{ segment.primary_emotion|title }}
                    </span>
                    <p class="timeline-text">{{ segment.text_content }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
        {% if timeline_preview|length >= 10 %}
        <div class="action-button-section">
            <a href="{{ url_for('views.transcription', id=experiment.id) }}" class="btn-action secondary">
                <i class="fas fa-list"></i>
                View Complete Timeline
            </a>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Questions & Analysis Stats -->
    <div class="two-column-grid">
        {% if questions_preview %}
        <div class="content-card">
            <div class="card-header-section">
                <h2 class="card-title">
                    <i class="fas fa-question-circle"></i>
                    Questions Detected
                </h2>
                <span class="count-badge">{{ analysis.questions.count() }}</span>
            </div>
            <div class="questions-list">
                {% for question in questions_preview %}
                <div class="question-item">
                    <div class="question-text">
                        <i class="fas fa-quote-left"></i>
                        {{ question.question_text }}
                    </div>
                    <div class="question-meta">
                        <span class="confidence-badge">
                            <i class="fas fa-check"></i>
                            Confidence: {{ "%.0f"|format(question.confidence * 100) }}%
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if analysis.questions.count() > 5 %}
            <div class="action-button-section">
                <a href="{{ url_for('views.transcription', id=experiment.id) }}" class="btn-action secondary">
                    View All Questions
                </a>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <div class="content-card">
            <div class="card-header-section">
                <h2 class="card-title">
                    <i class="fas fa-chart-bar"></i>
                    Analysis Statistics
                </h2>
            </div>
            <div class="stats-list">
                <div class="stat-item">
                    <div class="stat-item-icon">
                        <i class="fas fa-video"></i>
                    </div>
                    <div class="stat-item-content">
                        <div class="stat-item-label">Source Video</div>
                        <div class="stat-item-value">{{ analysis.source_filename }}</div>
                    </div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-item-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-item-content">
                        <div class="stat-item-label">Analyzed At</div>
                        <div class="stat-item-value">
                            {{ analysis.analyzed_at.strftime('%Y-%m-%d %H:%M:%S') if analysis.analyzed_at else 'N/A' }}
                        </div>
                    </div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-item-icon">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <div class="stat-item-content">
                        <div class="stat-item-label">Model Used</div>
                        <div class="stat-item-value">{{ analysis.model_used or 'N/A' }}</div>
                    </div>
                </div>
                
                <div class="stat-item highlight">
                    <div class="stat-item-icon">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="stat-item-content">
                        <div class="stat-item-label">Action Items Detected</div>
                        <div class="stat-item-value-large">{{ analysis.actions.count() }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- No Analysis Available -->
    <div class="content-card no-analysis-card">
        <div class="empty-state-container">
            <div class="empty-state-icon">
                <i class="fas fa-database"></i>
            </div>
            <h3 class="empty-state-title">No Emotion Analysis Data Available</h3>
            <p class="empty-state-description">
                Import emotion analysis data from MinIO to see detailed insights for this experiment.
            </p>
            <div class="code-block">
                <i class="fas fa-terminal"></i>
                <code>python connect_minio.py</code>
            </div>
            <p class="empty-state-note">
                <i class="fas fa-info-circle"></i>
                The import script will automatically link analysis data to this experiment based on the video filename or date.
            </p>
        </div>
    </div>
    {% endif %}
</div>

{% if analysis and summary and summary.emotion_percentages %}
<script>
    // Emotion Pie Chart
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('emotionPieChart');
        if (ctx) {
            const emotionData = {{ summary.emotion_percentages | tojson | safe }};
            
            const emotionColors = {
                'happy': '#48bb78',
                'sad': '#4299e1',
                'angry': '#f56565',
                'neutral': '#a0aec0',
                'fear': '#ed8936',
                'surprise': '#f6e05e',
                'disgust': '#9f7aea'
            };
            
            const labels = Object.keys(emotionData);
            const values = Object.values(emotionData);
            const colors = labels.map(l => emotionColors[l.toLowerCase()] || '#a0aec0');
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 13,
                                    weight: '600'
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: {
                                size: 14,
                                weight: '600'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
    });
</script>
{% endif %}
{% endblock %}