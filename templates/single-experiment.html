{% extends "base.html" %}

{% block title %}{{ experiment.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/single-experiment.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/experiments.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid pt-4">
    <a href="{{ url_for('views.experiments') }}" class="btn btn-primary">
        ← Back to Experiments
    </a>
    <br/><br/>
    
    <div class="header">
        <h1 class="header-title">
            {{ experiment.title }}
            {% if analysis %}
                <span class="analysis-badge">✓ Emotion Analysis Available</span>
            {% endif %}
        </h1>
    </div>

    <!-- Experiment Details Card -->
    <div class="card-2">
        <h2 class="header-subtitle-2">Experiment Details</h2>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Date:</span>
                <span class="info-value">{{ experiment.date.strftime('%B %d, %Y') if experiment.date else 'N/A' }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Participants:</span>
                <span class="info-value">{{ experiment.participant_count }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Duration:</span>
                <span class="info-value">{{ experiment.format_duration() }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Status:</span>
                <span class="info-value">{{ experiment.status }}</span>
            </div>
        </div>
        
        {% if experiment.description %}
        <div class="description-section">
            <h3>Description</h3>
            <p>{{ experiment.description }}</p>
        </div>
        {% endif %}
        
        {% if experiment.tags %}
        <div class="tags-section">
            <h3>Tags</h3>
            <div class="tags-list">
                {% for tag in experiment.tags.split(',') %}
                <span class="tag">{{ tag.strip() }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    {% if analysis %}
    <!-- Emotion Analysis Overview -->
    <div class="card-2">
        <h2>Emotion Analysis Overview</h2>
        <div class="row">
            <div class="col-md-3 mb-3">
                <div class="emotion-stat-box">
                    <h4>Dominant Emotion</h4>
                    <div class="value">{{ analysis.dominant_emotion|title }}</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="emotion-stat-box">
                    <h4>Total Segments</h4>
                    <div class="value">{{ analysis.total_segments or 0 }}</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="emotion-stat-box">
                    <h4>Words Analyzed</h4>
                    <div class="value">{{ analysis.word_count or 0 }}</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="emotion-stat-box">
                    <h4>Reading Time</h4>
                    <div class="value">{{ "%.1f"|format(analysis.reading_time_minutes or 0) }}m</div>
                </div>
            </div>
        </div>

        {% if summary and summary.emotion_percentages %}
        <div style="margin-top: 2rem;">
            <h3 style="color: #2d3748; margin-bottom: 1rem;">Emotion Distribution</h3>
            <div class="row">
                <div class="col-md-8">
                    {% for emotion, percentage in summary.emotion_percentages.items() %}
                    <div class="emotion-bar-container">
                        <div class="emotion-bar-label">
                            <span>{{ emotion|title }}</span>
                            <span>{{ "%.1f"|format(percentage) }}%</span>
                        </div>
                        <div class="emotion-bar">
                            <div class="emotion-bar-fill" style="width: {{ percentage }}%;"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="col-md-4">
                    <canvas id="emotionPieChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
        {% endif %}

        <div style="margin-top: 2rem; text-align: center;">
            <a href="{{ url_for('views.transcription', id=experiment.id) }}" class="btn btn-primary btn-lg">
                View Full Emotion Analysis →
            </a>
        </div>
    </div>

    <!-- Keywords Section -->
    {% if keywords_preview %}
    <div class="card-2">
        <h2>Top Keywords</h2>
        <div class="keyword-cloud">
            {% for keyword in keywords_preview %}
                <span class="keyword-tag">{{ keyword.text }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Timeline Preview -->
    {% if timeline_preview %}
    <div class="card-2">
        <h2>Emotion Timeline Preview</h2>
        <div class="timeline-preview">
            {% for segment in timeline_preview %}
            <div class="timeline-item">
                <div class="timeline-time">{{ "%.1f"|format(segment.start_time) }}s</div>
                <span class="timeline-emotion">{{ segment.primary_emotion|title }}</span>
                <div class="timeline-text">{{ segment.text_content }}</div>
            </div>
            {% endfor %}
        </div>
        {% if timeline_preview|length >= 10 %}
        <div style="text-align: center; margin-top: 1rem;">
            <a href="{{ url_for('views.transcription', id=experiment.id) }}" class="btn btn-secondary">
                View Complete Timeline
            </a>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Questions & Actions -->
    <div class="row">
        {% if questions_preview %}
        <div class="col-md-6">
            <div class="card-2">
                <h2>Questions Detected ({{ analysis.questions.count() }})</h2>
                {% for question in questions_preview %}
                <div class="list-item">
                    <div class="list-item-text">{{ question.question_text }}</div>
                    <div class="list-item-meta">
                        Confidence: {{ "%.0f"|format(question.confidence * 100) }}%
                    </div>
                </div>
                {% endfor %}
                {% if analysis.questions.count() > 5 %}
                <div style="text-align: center; margin-top: 1rem;">
                    <a href="{{ url_for('views.transcription', id=experiment.id) }}" class="btn btn-secondary">
                        View All Questions
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="col-md-6">
            <div class="card-2">
                <h2>Analysis Stats</h2>
                <div class="emotion-stat-box" style="margin-bottom: 1rem;">
                    <h4>Source Video</h4>
                    <div style="color: #4a5568; font-size: 1rem; margin-top: 0.5rem;">
                        {{ analysis.source_filename }}
                    </div>
                </div>
                <div class="emotion-stat-box" style="margin-bottom: 1rem;">
                    <h4>Analyzed At</h4>
                    <div style="color: #4a5568; font-size: 1rem; margin-top: 0.5rem;">
                        {{ analysis.analyzed_at.strftime('%Y-%m-%d %H:%M:%S') if analysis.analyzed_at else 'N/A' }}
                    </div>
                </div>
                <div class="emotion-stat-box" style="margin-bottom: 1rem;">
                    <h4>Model Used</h4>
                    <div style="color: #4a5568; font-size: 1rem; margin-top: 0.5rem;">
                        {{ analysis.model_used or 'N/A' }}
                    </div>
                </div>
                <div class="emotion-stat-box">
                    <h4>Action Items Detected</h4>
                    <div class="value">{{ analysis.actions.count() }}</div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- No Analysis Available -->
    <div class="card-2">
        <h2>Emotion Analysis</h2>
        <div class="no-analysis-box">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <h3>No Emotion Analysis Data Available</h3>
            <p>Import emotion analysis data from MinIO to see detailed insights for this experiment.</p>
            <code>python connect_minio.py</code>
            <p style="margin-top: 1rem; font-size: 0.875rem;">
                The import script will automatically link analysis data to this experiment based on the video filename or date.
            </p>
        </div>
    </div>
    {% endif %}
</div>

{% if analysis and summary and summary.emotion_percentages %}
<script>
    // Emotion Pie Chart
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('emotionPieChart');
        if (ctx) {
            const emotionData = {{ summary.emotion_percentages | tojson | safe }};
            
            const emotionColors = {
                'happy': '#48bb78',
                'sad': '#4299e1',
                'angry': '#f56565',
                'neutral': '#a0aec0',
                'fear': '#ed8936',
                'surprise': '#f6e05e',
                'disgust': '#9f7aea'
            };
            
            const labels = Object.keys(emotionData);
            const values = Object.values(emotionData);
            const colors = labels.map(l => emotionColors[l.toLowerCase()] || '#a0aec0');
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }
    });
</script>
{% endif %}
{% endblock %}